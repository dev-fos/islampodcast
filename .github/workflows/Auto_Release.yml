name: Auto Release on Folder Change

on:
  push:
    branches:
      - main # or your default branch, e.g., master
    paths:
      - 'الملفات-المجمعه/**' # Specify the folder to watch

jobs:
  create-release-and-upload:
    runs-on: ubuntu-latest
    # Ensure this job only runs if files in the specified path actually changed in the push
    permissions:
      contents: write # This grants the necessary permission for actions like creating releases or pushing commits
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to calculate commit history for potential release notes

      - name: Set up environment variables for release
        id: set_env
        run: |
          # Generate a dynamic tag and release name based on the current date/time or commit hash
          # A more robust versioning strategy might involve a separate action or tool
          RELEASE_TAG="$(date +'%Y.%m.%d-%H.%M.%S')"
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          echo "ASSET_PATH=الملفات-المجمعه" >> $GITHUB_ENV # The folder to upload

      - name: Get latest release tag
        id: get_latest_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
          if [ -z "$LATEST_TAG" ]; then
            # If no tags exist, use a default base (e.g., the first commit SHA)
            LATEST_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
          
      - name: Get changed files
        id: get_files
        run: |
          # Disable quoting of UTF-8 filenames
          git config core.quotepath false 
          
          TARGET_DIR="الملفات-المجمعه"

          # Get list of changed files between the latest tag and the current HEAD
          CHANGED_FILES=$(git diff --name-only ${{ steps.get_latest_tag.outputs.LATEST_TAG }} HEAD)

          FILTERED=$(printf "%s\n" "$CHANGED_FILES" | grep "^${TARGET_DIR}/" || true)
          
          # Format the list into a markdown string with bullet points
          FILE_LIST=$(printf "%s\n" "$FILTERED" | sed 's/^/* /')
          # GitHub expects newlines as %0A and percent signs as %25.
          ENCODED="${FILE_LIST//'%'/'%25'}"
          ENCODED="${ENCODED//$'\n'/'%0A'}"
          ENCODED="${ENCODED//$'\r'/'%0D'}"
          echo "RELEASE_NOTES=$ENCODED" >> "$GITHUB_OUTPUT"

      - name: Generate colored diff stat
        id: changelog
        run: |
          git config core.quotepath false
          # TARGET_DIR="path/to/folder"
          LATEST_TAG="${{ steps.get_latest_tag.outputs.LATEST_TAG }}"

          # احصل على إحصائية diff‑stat داخل المجلد
          STAT=$(git diff --stat "$LATEST_TAG" HEAD)

          # احصل على diff الكامل لتلوين الإضافات/الحذف
          FULL_DIFF=$(git diff --stat "$LATEST_TAG" HEAD  | head -n -1)

          ## ترميز المتغيّر لتخزينه في GITHUB_OUTPUT
          # ENCODED="${CONTENT//'%'/'%25'}"
          # ENCODED="${ENCODED//$'\n'/'%0A'}"
          # ENCODED="${ENCODED//$'\r'/'%0D'}"

          #  echo "RELEASE_NOTES=$ENCODED" >> "$GITHUB_OUTPUT"

            FILES=$(echo "$STAT" | grep -oE '[0-9]+ files? changed' | grep -oE '[0-9]+')
          # عدد الإضافات (قد لا تكون موجودة إذا كانت 0)
            INSERTIONS=$(echo "$STAT" | grep -oE '[0-9]+ insertions?' | grep -oE '[0-9]+' || echo "0")
          # عدد الحذف (قد لا تكون موجودة إذا كانت 0)
           DELETIONS=$(echo "$STAT" | grep -oE '[0-9]+ deletions?' | grep -oE '[0-9]+' || echo "0")

           AR_SUMMARY="<div dir="rtl"> ${FILES} ملفات تم تعديلها، ${INSERTIONS} إضافة(+)، ${DELETIONS} حذف(-) </div>"

           # دمج الإحصائية مع الـ diff الملون
            CONTENT=$(printf "%s\n" "$FULL_DIFF" | sed 's/^/* /')$'\n\n'"${AR_SUMMARY}"

            
            
          {
           echo "RELEASE_NOTES<<EOF"
           echo "$CONTENT"
           echo "EOF"
          } >> "$GITHUB_OUTPUT"

          

          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Default token has permissions
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          release_name: تحديث ${{ env.RELEASE_TAG }}
          body: |
          
            <div dir="rtl">
            
            ## الملف المستهدف فى هذا التحديث :

            </div>
            
            ${{ steps.get_files.outputs.RELEASE_NOTES }}

            <div dir="rtl">
            
            ## لتحميل الملف المطلوب , اضغط على اسم المحتوى :
            <a href="https://github.com/dev-fos/islampodcast/releases/latest/download/a-alqasim.opml" >الشيخ د. عبد المحسن القاسم</a>
            <a href="https://github.com/dev-fos/islampodcast/releases/latest/download/al-badr.opml" >الشيخ د. عبد الرزاق البدر</a>
            <a href="https://github.com/dev-fos/islampodcast/releases/latest/download/khaledalsabt.opml" >الشيخ أ.د. خالد السبت</a>
            <a href="https://github.com/dev-fos/islampodcast/releases/latest/download/al-osyme.opml" >الشيخ د. صالح العُصَيمِيّ</a>

            </div>
            <div dir="rtl">
            
            ## قائمة بكل التعديلات التى تمت :

            </div>

          
             ${{ steps.changelog.outputs.RELEASE_NOTES }}
            
            
          draft: false # Set to true to create a draft release
          prerelease: false

   #   - name: Upload Release Assets
   #     uses: actions/upload-release-asset@v1
   #     env:
   #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
   #     with:
   #       # Use a glob pattern to upload all files within the folder
   #       upload_url: ${{ steps.create_release.outputs.upload_url }}
   #       asset_path: ${{ env.ASSET_PATH }}
   #       asset_name: ${{ env.ASSET_PATH }}_files.zip # Note: the upload action typically takes one file path, so you may need to zip the folder first.
   #       asset_content_type: application/zip # Adjust content type based on the file type
          
      - name: Upload Multiple Assets to Release
        # Use a single step with the GitHub CLI to upload multiple files
        # The GitHub CLI is pre-installed on all GitHub runners
        run: |
          # Use a loop or glob pattern to upload multiple files
          # The files will be uploaded without compression
          TAG="${{ env.RELEASE_TAG }}"
          UPLOAD_URL="${{ steps.create_release.outputs.upload_url }}"
          FOLDER_PATH="الملفات-المجمعه" # The folder with files to upload

          # Example for uploading all files in the folder
          for FILE_PATH in "$FOLDER_PATH"/*; do
            if [ -f "$FILE_PATH" ]; then
              gh release upload "$TAG" "$FILE_PATH" --clobber
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
